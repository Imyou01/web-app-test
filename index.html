<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Quản Lý Trung Tâm</title>
    <link rel="stylesheet" href="styles.css"> 
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   <script src="https://unpkg.com/lucide-static@latest/dist/lucide.min.js"></script>
</head>
<body>

    <div class="loading" id="loading" style="display: none;">
        <div class="loading__spinner"></div>
    </div>
        <div class="auth-container" id="auth-container">
            <div class="auth-form auth-form--login active" id="login-form">
                <h2 class="auth-form__title">Đăng Nhập</h2>
                <div class="auth-form__field">
                    <label for="login-email" class="auth-form__label">Email</label>
                    <input type="email" id="login-email" class="auth-form__input" required>
                </div>
                <div class="auth-form__field">
                    <label for="login-password" class="auth-form__label">Mật khẩu</label>
                    <input type="password" id="login-password" class="auth-form__input" required>
                </div>
                <button onclick="login()" class="auth-form__button">Đăng Nhập</button>
                <p class="auth-form__switch">Chưa có tài khoản? <a href="#" onclick="showForm('register')">Đăng ký</a></p>
                <p class="auth-form__switch"><a href="#" onclick="showForm('forgot')">Quên mật khẩu?</a></p>
            </div>

            <div class="auth-form auth-form--register" id="register-form">
                <h2 class="auth-form__title">Đăng Ký</h2>
                <div class="auth-form__field">
                    <label for="register-name" class="auth-form__label">Họ và Tên</label>
                    <input type="text" id="register-name" class="auth-form__input" required>
                </div>
                <div class="auth-form__field">
                    <label for="register-email" class="auth-form__label">Email</label>
                    <input type="email" id="register-email" class="auth-form__input" required>
                </div>
                <div class="auth-form__field">
                    <label for="register-password" class="auth-form__label">Mật khẩu</label>
                    <input type="password" id="register-password" class="auth-form__input" required>
                </div>
                <button onclick="register()" class="auth-form__button">Đăng Ký</button>
                <p class="auth-form__switch">Đã có tài khoản? <a href="#" onclick="showForm('login')">Đăng nhập</a></p>
            </div>
            
            <div class="auth-form auth-form--forgot" id="forgot-form">
                <h2 class="auth-form__title">Quên Mật Khẩu</h2>
                <div class="auth-form__field">
                    <label for="forgot-email" class="auth-form__label">Nhập Email của bạn</label>
                    <input type="email" id="forgot-email" class="auth-form__input" required>
                </div>
                <button onclick="forgotPassword()" class="auth-form__button">Gửi Link Reset</button>
                <p class="auth-form__switch"><a href="#" onclick="showForm('login')">Quay lại Đăng nhập</a></p>
            </div>
        </div>

        <div class="role-selection" id="role-selection" style="display: none;">
            <h2 class="role-selection__title">Chọn Chức Vụ Của Bạn</h2>
            <p class="role-selection__description">Vui lòng chọn chức vụ để tiếp tục. Lựa chọn này sẽ được gửi đến quản trị viên để duyệt.</p>
            <select id="select-role" class="role-selection__dropdown">
                <option value="">-- Chọn chức vụ --</option>
              <!--  <option value="Admin">Admin</option> -->
                <option value="Hội Đồng">Hội Đồng</option>
                <option value="Giáo Viên">Giáo Viên</option>
                <option value="Trợ Giảng">Trợ Giảng</option>
            </select>
            <button onclick="saveUserRole()" class="role-selection__button">Lưu và Tiếp Tục</button>
        </div>
             <div class="pending-approval" id="pending-approval-screen" style="display: none;">
            <h2 class="pending-approval__title">Tài khoản đang chờ duyệt</h2>
            <p class="pending-approval__description">
                Yêu cầu của bạn đã được gửi đến quản trị viên. Vui lòng quay lại sau khi tài khoản của bạn đã được phê duyệt.
            </p>
            <button onclick="logout()" class="pending-approval__button">Đăng Xuất</button>
        </div>

<div class="app-layout" id="app-layout" style="display: none;"> 
    <aside class="sidebar">
        <div class="sidebar__profile">
            <img id="avatar-img" src="default-avatar.png" alt="Avatar" class="sidebar__avatar" onclick="openProfile()">
            <span id="display-name-hello" class="sidebar__username">Username</span>
        </div>

        <nav class="sidebar__nav">
            <ul class="sidebar__nav-list">
                <li class="sidebar__nav-item">
                    <a href="#dashboard" class="sidebar__nav-link">
                        <img src="icons/dashboard.svg" class="sidebar-icon" alt="Bảng Điều Khiển">
                        <span>Bảng Điều Khiển</span>
                    </a>
                </li>
                <li class="sidebar__nav-item">
                    <a href="#student-management" class="sidebar__nav-link">
                        <img src="icons/student.svg" class="sidebar-icon" alt="Quản Lý Học Viên">
                        <span>Quản Lý Học Viên</span>
                    </a>
                </li>
                <li class="sidebar__nav-item">
                    <a href="#class-management" class="sidebar__nav-link">
                        <img src="icons/class.svg" class="sidebar-icon" alt="Quản Lý Lớp Học">
                        <span>Quản Lý Lớp Học</span>
                    </a>
                </li>
                <li class="sidebar__nav-item">
                    <a href="#new-schedule-page" class="sidebar__nav-link">
                        <img src="icons/calendar.svg" class="sidebar-icon" alt="Quản Lý Lịch Học">
                        <span>Quản Lý Lịch Học</span>
                    </a>
                </li>
                <li class="sidebar__nav-item">
                    <a href="#personnel-management" class="sidebar__nav-link">
                       <img src="icons/personnel.svg" class="sidebar-icon" alt="Quản Lý Nhân Sự">
                        <span>Quản Lý Nhân Sự</span>
                    </a>
                </li>

                <li class="sidebar__nav-item" id="nav-code">
                 <a href="#code-management" class="sidebar__nav-link">
                  <img src="icons/key.svg" class="sidebar-icon" alt="Quản Lý Mã">
                 <span>Quản Lý Mã</span>
                 </a>
                </li>

                 <li class="sidebar__nav-item">
                    <a href="#account-management" class="sidebar__nav-link">
                       <img src="icons/account.svg" class="sidebar-icon" alt="Quản Lý Tài Khoản">
                        <span>Quản Lý Tài Khoản</span>
                    </a>
                </li>
                <li class="sidebar__nav-item">
                    <a href="#tuition-management" class="sidebar__nav-link">
                        <img src="icons/tuition.svg" class="sidebar-icon" alt="Quản Lý Học Phí">
                        <span>Quản Lý Học Phí</span>
                    </a>
                </li>
                <li class="sidebar__nav-item" id="nav-activity-log" style="display: none;"> <a href="#activity-log-page" class="sidebar__nav-link">
            <img src="icons/history.svg" class="sidebar-icon" alt="Nhật ký Hoạt động">
            <span>Nhật ký Hoạt động</span>
        </a>
    </li>
            </ul>
        </nav>
    </aside>

    <div class="content-wrapper">
        <header class="top-bar">
            <h1 class="top-bar__title">Quản Lý Trung Tâm</h1>
            <button onclick="logout()" class="top-bar__logout-button">
                <i data-lucide="log-out"></i>
                <span>Đăng Xuất</span>
            </button>
        </header>

        <main class="main-content">
            <section class="dashboard" id="dashboard">
                <div class="dashboard__content">
                 <h1 class="dashboard__welcome-message" id="welcome-message"></h1>
                 <div class="dashboard__date" id="live-date"></div> 
                 <div class="dashboard__clock" id="live-clock"></div>
                </div>
                <div class="dashboard__charts-grid">
    <div class="chart-container">
        <h3 class="chart-title">Sĩ số 5 lớp đông nhất</h3>
        <canvas id="class-size-chart"></canvas>
    </div>
    <div class="chart-container">
        <h3 class="chart-title">Học viên mới trong 6 tháng qua</h3>
        <canvas id="new-students-chart"></canvas>
    </div>
    <a href="#trash-management" class="dashboard__card">
    <h3 class="dashboard__card-title">
        <i data-lucide="trash-2"></i> Thùng rác
    </h3>
    <p class="dashboard__card-description">
        Xem lại và quản lý các học viên, lớp học đã bị xóa.
    </p>
</a>
    <a href="#" id="recalculate-sessions-btn" class="dashboard__card" onclick="event.preventDefault(); auditAndRecalculateGeneralEnglish();" style="display: none; background-color: #fff3cd; border: 1px solid #ffeeba;">
        <h3 class="dashboard__card-title">
            <i data-lucide="refresh-cw"></i> Tính Lại Số Buổi Học
        </h3>
        <p class="dashboard__card-description" style="color: #664d03;">
            (Chỉ Admin) Chạy kiểm toán và tính lại tổng số buổi đã học cho tất cả học viên lớp phổ thông.
        </p>
    </a>
</div>
            </section>
            <section class="student-management" id="student-management" style="display: none;">
    <div class="page-header">
        <h2 class="page-header__title">Quản Lý Học Viên</h2>
         <div class="button-group"> <button id="export-cycle-report-btn" class="page-header__button page-header__button--danger" onclick="showStudentSelectorForCycleReport()" style="display: none;">
                <i data-lucide="repeat"></i> Xem Chu Kỳ Học
            </button>
            <button class="page-header__button" onclick="showStudentForm()">Thêm Học Viên Mới</button>
        </div>
    </div>
    <div class="student-management__controls">
        <input type="text" id="student-search" class="student-management__search" placeholder="Tìm kiếm theo tên, SĐT..." oninput="filterStudentsBySearch()">
        <select id="student-filter-class" class="student-management__filter" onchange="applyStudentFilters()"></select>

        <select id="student-filter-zalo" class="student-management__filter" onchange="applyStudentFilters()">
        <option value="">-- Lọc theo Zalo --</option>
        <option value="yes">Đã tick Zalo</option>
        <option value="no">Chưa tick Zalo</option>
    </select>
    <select id="student-filter-phone" class="student-management__filter" onchange="applyStudentFilters()">
        <option value="">-- Lọc theo Điện thoại --</option>
        <option value="yes">Đã tick Điện thoại</option>
        <option value="no">Chưa tick Điện thoại</option>
    </select>

        <button class="student-management__reset-button" onclick="resetStudentFilters()">Reset</button>
    </div>
     <div class="student-management__summary">
        <span id="total-students-display"></span>
        <span id="paid-students-display"></span>
    </div>
    <div class="data-table-wrapper">
        <table class="data-table">
            <thead class="data-table__head">
                <tr class="data-table__row">
                    <th class="data-table__header">Họ và tên</th>
                    <th class="data-table__header">Năm sinh</th>
                    <th class="data-table__header">Ngày bắt đầu chu kì</th>
                    <th class="data-table__header">Gói đăng ký</th>
                    <th class="data-table__header data-table__header--sortable" onclick="sortStudentsBy('createdAt')">
                        Ngày tạo <span id="sort-icon-createdAt"></span>
                    </th>
                    <th class="data-table__header data-table__header--sortable" onclick="sortStudentsBy('updatedAt')">
                        Ngày sửa đổi <span id="sort-icon-updatedAt"></span>
                    </th>
                  <!--  <th class="data-table__header">Học phí</th>  -->
                    <th class="data-table__header">Thanh Toán Gói Hiện Tại</th>
                    <th class="data-table__header th-sessions-attended">Số buổi đã học</th>
                    <th class="data-table__header th-sessions-remaining">Buổi còn lại</th>
                    <th class="data-table__header">Thông báo</th> <th class="data-table__header">Hành động</th>
                </tr>
            </thead>
            <tbody id="student-list" class="data-table__body">
                </tbody>
        </table>
    </div>
     <div class="student-management__pagination">
        <button id="prev-page" onclick="changeStudentPage(currentStudentPage - 1)">Trước</button>
        <span id="page-info"></span>
        <button id="next-page" onclick="changeStudentPage(currentStudentPage + 1)">Sau</button>
    </div>
</section>
        <section class="class-management" id="class-management" style="display: none;">
    <div class="page-header">
        <h2 class="page-header__title">Quản Lý Lớp Học</h2>
        <button class="page-header__button" onclick="showClassForm()">Tạo Lớp Học Mới</button>
    </div>
    <div class="personnel-management__controls">
        <button id="btn-active-classes" class="personnel-management__toggle-button active" onclick="showClassView('active')">Lớp còn hoạt động</button>
        <button id="btn-completed-classes" class="personnel-management__toggle-button" onclick="showClassView('completed')">Lớp đã hoàn thành</button>
    </div>
    <div class="class-management__layout">
    <div class="class-management__layout">
        <div class="class-management__list-container">
             <input type="text" id="class-search" class="class-management__search" placeholder="Tìm kiếm lớp, giáo viên..." oninput="filterClassesBySearch()">
            <table class="data-table">
                <thead class="data-table__head">
                    <tr class="data-table__row">
                        <th class="data-table__header">Tên lớp</th>
                        <th class="data-table__header">Sĩ số</th>
                        <th class="data-table__header">Giáo viên</th>
                        <th class="data-table__header">Hành động</th>
                    </tr>
                </thead>
                <tbody id="class-list" class="data-table__body">
                </tbody>
            </table>
        </div>
    </div>
</section>

<section class="management-page" id="new-schedule-page" style="display: none;">
    <div class="page-header">
        <h2 class="page-header__title" id="schedule-week-title">Thời Khóa Biểu</h2>
        <div class="page-header__controls">
            <button id="schedule-prev-week" class="page-header__button">&lt; Tuần Trước</button>
            <button id="schedule-next-week" class="page-header__button">Tuần Sau &gt;</button>
        </div>
    </div>
    
    <div class="schedule-page__grid-wrapper">
        <div class="schedule-page__grid" id="schedule-grid-container">
            </div>
    </div>

    <div class="schedule-page__tooltip" id="schedule-tooltip"></div>
</section>

<section class="personnel-management" id="personnel-management" style="display: none;">
    <div class="page-header">
        <h2 class="page-header__title">Quản Lý Nhân Sự</h2>
    </div>
    <div class="personnel-management__controls personnel-controls">
        <button id="btn-show-personnel-classes" class="personnel-management__toggle-button active" onclick="showPersonnelSection('classes')">Danh sách lớp (Chấm công)</button>
        <button id="btn-show-personnel-staff" class="personnel-management__toggle-button" onclick="showPersonnelSection('staff')">Danh sách nhân sự (Lương)</button>
    </div>
    <div id="personnel-classes-section" class="personnel-management__section">
    </div>
    <div id="personnel-staff-section" class="personnel-management__section" style="display: none;">
        <div class="data-table-wrapper">
            <table class="data-table">
                <thead class="data-table__head">
                    <tr class="data-table__row">
                        <th class="data-table__header">Tên nhân sự</th>
                        <th class="data-table__header">Email</th>
                        <th class="data-table__header">Lương Giáo Viên (theo lớp)</th>
                        <th class="data-table__header">Lương Trợ Giảng (theo lớp)</th>
                        <th class="data-table__header">Hành động</th>
                    </tr>
                </thead>
                <tbody id="staff-salary-list" class="data-table__body">
                </tbody>
            </table>
        </div>
    </div>
</section>

<section class="account-management" id="account-management" style="display: none;">
    <div class="page-header">
        <h2 class="page-header__title">Quản Lý Tài Khoản</h2>
    </div>
    <div class="data-table-wrapper">
         <table class="data-table">
            <thead class="data-table__head">
                <tr class="data-table__row">
                    <th class="data-table__header">Email</th>
                    <th class="data-table__header">Họ và Tên</th>
                    <th class="data-table__header">Username</th>
                    <th class="data-table__header">Chức vụ</th>
                    <th class="data-table__header">Hành động</th>
                </tr>
            </thead>
            <tbody id="account-list" class="data-table__body">
            </tbody>
        </table>
    </div>
</section>

<section class="management-page" id="tuition-management" style="display: none;">
    <div class="page-header">
        <h2 class="page-header__title">Quản Lý Tài Chính</h2>
    </div>

  <div class="tabs" id="tuition-page-tabs">
    <button class="tabs__button active" onclick="openPageTab(event, 'fee-management', 'tuition-management')">Quản lý Học phí</button>
    <button class="tabs__button" onclick="openPageTab(event, 'book-management', 'tuition-management')">Quản lý Tiền sách</button>
</div>

    <div id="fee-management" class="tabs__content active">
        <div class="tuition-management__controls">
            <input type="text" id="tuition-class-search" class="tuition-management__search" placeholder="Tìm kiếm lớp học..." oninput="renderTuitionView(this.value)">
        </div>
        <div id="tuition-class-list" class="tuition-management__class-list">
            </div>
    </div>

    <div id="book-management" class="tabs__content">
         <div class="tuition-management__controls">
            <input type="text" id="book-class-search" class="tuition-management__search" placeholder="Tìm kiếm lớp học..." oninput="renderTuitionView(this.value, 'book')">
        </div>
        <div id="book-class-list" class="tuition-management__class-list">
            </div>
    </div>
</section>

<section class="profile-page" id="profile-page" style="display: none;">
    <h2 class="profile-page__title">Thông Tin Cá Nhân</h2>
    <div class="profile-page__card">
        <div class="profile-page__avatar-wrapper">
            <img src="default-avatar.png" alt="Avatar" id="profile-avatar" class="profile-page__avatar">
            <input type="file" id="avatar-file" accept="image/*" class="profile-page__file-input">
            <label for="avatar-file" class="profile-page__upload-label">Thay đổi ảnh</label>
        </div>
        <div class="profile-page__details">
            <p><strong>Họ và tên:</strong> <span id="profile-name"></span></p>
            <p><strong>Email:</strong> <span id="profile-email"></span></p>
            <p><strong>Chức vụ:</strong> <span id="profile-role"></span></p>
        </div>
    </div>
</section>
            <section class="management-page" id="trash-management" style="display: none;">
    <div class="page-header">
        <h2 class="page-header__title">Thùng rác</h2>
    </div>

    <h3 class="section-subtitle">Học viên đã xóa</h3>
    <div class="data-table-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th class="data-table__header">Họ và tên</th>
                    <th class="data-table__header">Năm sinh</th>
                    <th class="data-table__header">Gói đăng ký</th>
                    <th class="data-table__header">Hành động</th>
                </tr>
            </thead>
            <tbody id="deleted-student-list">
                </tbody>
        </table>
    </div>

    <h3 class="section-subtitle" style="margin-top: 30px;">Lớp học đã xóa</h3>
    <div class="data-table-wrapper">
        <table class="data-table">
            <thead>
                <tr>
                    <th class="data-table__header">Tên lớp</th>
                    <th class="data-table__header">Giáo viên</th>
                    <th class="data-table__header">Hành động</th>
                </tr>
            </thead>
            <tbody id="deleted-class-list">
                </tbody>
        </table>
    </div>
</section>
    <section class="management-page" id="activity-log-page" style="display: none;">
    <div class="page-header">
        <h2 class="page-header__title">Nhật ký Hoạt động Hệ thống</h2>
    </div>
    <div class="data-table-wrapper">
        <table class="data-table">
            <thead class="data-table__head">
                <tr class="data-table__row">
                    <th class="data-table__header">Thời gian</th>
                    <th class="data-table__header">Người thực hiện</th>
                    <th class="data-table__header">Vai trò</th>
                    <th class="data-table__header">Hành động</th>
                </tr>
            </thead>
            <tbody id="activity-log-list" class="data-table__body">
                </tbody>
        </table>
    </div>
</section>
 </section> <section class="management-page" id="code-management" style="display: none;">
    <div class="page-header">
        <h2 class="page-header__title">Quản Lý Mã Nhân Sự</h2>
        <button class="page-header__button" onclick="addNewPersonnelCodeRow()">Thêm Nhân Sự Mới</button>
    </div>
    <div class="data-table-wrapper">
        <table class="data-table">
            <thead class="data-table__head">
                <tr class="data-table__row">
                    <th class="data-table__header">Tên Nhân Sự</th>
                    <th class="data-table__header">Mật Mã (6 số)</th>
                    <th class="data-table__header">Hành động</th>
                </tr>
            </thead>
            <tbody id="personnel-code-list" class="data-table__body">
                </tbody>
        </table>
    </div>
    </section>
            </main>
    </div>
</div>
    
    <div class="modal modal--student-form" id="student-form-modal" style="display: none;">
        <div class="modal__overlay" onclick="hideStudentForm()"></div>
        <div class="modal__content" id="student-form-container">
    <div class="modal__header">
        <h3 class="modal__title" id="student-form-title">Tạo hồ sơ học viên mới</h3>
        <button class="modal__close-btn" onclick="hideStudentForm()">&times;</button>
    </div>
    <form id="student-form" class="modal__form" onsubmit="event.preventDefault(); saveStudent();">
        <input type="hidden" id="student-index">
        <input type="hidden" id="student-new-package-sessions">
        
        <div class="form-grid">
            <div class="form-grid__field">
                <label for="student-name">Họ và tên học viên *</label>
                <input type="text" id="student-name" required>
            </div>
            <div class="form-grid__field">
                 <label for="student-dob">Năm sinh *</label>
                <input type="number" id="student-dob" oninput="handleAgeChange()" required>
            </div>
            <div class="form-grid__field form-grid__field--full">
                 <label for="student-address">Địa chỉ</label>
                <input type="text" id="student-address">
            </div>
            <div id="contact-info-container" class="form-grid__field form-grid__field--full"></div>
            <div class="form-grid__field">
                <label for="student-parent-job">Nghề nghiệp phụ huynh</label>
                <select id="student-parent-job" onchange="parentJobChange(this.value)">
                    <option value="">-- Chọn --</option>
                    <option value="Bác sĩ">Bác sĩ</option>
                    <option value="Giáo viên">Giáo viên</option>
                    <option value="Kinh doanh">Kinh doanh</option>
                    <option value="Công nhân">Công nhân</option>
                    <option value="Khác">Khác</option>
                </select>
                <input type="text" id="student-parent-job-other" style="display:none;" placeholder="Nhập nghề nghiệp khác">
            </div>
           
        </div>
        
        <hr class="form__divider">
        
        <div class="form-grid">
            <div class="form-grid__field">
                <label for="student-package-type">Loại gói học *</label>
                <select id="student-package-type" onchange="handlePackageTypeChange()" required>
    <option value="">-- Chọn loại gói --</option>
    <option value="Phổ thông">Phổ thông</option>
    <option value="Chứng chỉ">Chứng chỉ</option>
    <option value="Các môn trên trường">Các môn trên trường</option> </select>
            </div>

            <div id="general-course-type-container" class="form-grid__field form-grid__field--full form-field--hidden">
                <label>Chọn chương trình học phổ thông</label>
                <div class="radio-group">
                    <input type="radio" id="radio-general-en" name="general-type" value="english" onchange="handleGeneralCourseTypeChange()">
                    <label for="radio-general-en">Tiếng Anh Phổ thông</label>
                    <input type="radio" id="radio-general-zh" name="general-type" value="chinese" onchange="handleGeneralCourseTypeChange()">
                    <label for="radio-general-zh">Tiếng Trung Phổ thông</label>
                </div>
            </div>

            <div id="general-english-options-container" class="form-grid__field form-grid__field--full form-field--hidden">
                <label for="general-english-course">Chọn khóa học Tiếng Anh</label>
                <select id="general-english-course" onchange="updateStudentPackageName()"></select>
            </div>

            <div id="general-chinese-options-container" class="form-grid__field form-grid__field--full form-field--hidden">
                <div class="form-grid">
                    <div class="form-grid__field">
                        <label for="general-chinese-combo-select">Chọn Combo</label>
                        <select id="general-chinese-combo-select" onchange="updateStudentPackageName()"></select>
                    </div>
                    <div class="form-grid__field">
                        <label for="general-chinese-age-select">Chọn Lứa tuổi</label>
                        <select id="general-chinese-age-select" onchange="updateStudentPackageName()"></select>
                    </div>
                </div>
            </div>
        <div id="school-subject-options-container" class="form-grid__field form-grid__field--full form-field--hidden">
                <div class="form-grid">
                    <div class="form-grid__field">
                        <label for="school-subject-select">Chọn Môn học</label>
                        <select id="school-subject-select" onchange="updateStudentPackageName()"></select>
                    </div>
                    <div class="form-grid__field">
                        <label for="school-grade-select">Chọn Khối lớp</label>
                        <select id="school-grade-select" onchange="updateStudentPackageName()"></select>
                    </div>
                    <div class="form-grid__field">
                        <label for="school-combo-select">Chọn Combo</label>
                        <select id="school-combo-select" onchange="updateStudentPackageName()"></select>
                    </div>
                </div>
            </div>
            <div id="certificate-options-container" class="form-grid__field form-grid__field--full form-field--hidden">
    <label for="student-certificate-type">Chọn loại chứng chỉ</label>
    <select id="student-certificate-type" onchange="populateCourseDropdown()">
        <option value="">-- Chọn --</option>
        <option value="IELTS">IELTS</option>
        <option value="TOEIC">TOEIC</option>
        <option value="HSK">HSK</option>
        <option value="YCT">YCT</option>
    </select>
    
    <div id="certificate-course-wrapper" class="form-field--hidden" style="margin-top: 10px;">
        <label for="student-certificate-course">Chọn khóa học</label>
        <select id="student-certificate-course"></select>
    </div>
    
    <div id="combo-selection-container" class="form-field--hidden" style="margin-top: 10px;">
        <h4 id="combo-selection-title"></h4>
        <div id="combo-checkboxes-list"></div>
    </div>
</div>

            <div class="form-grid__field form-grid__field--full">
                <label>Tên gói đăng ký (tự động)</label>
                <input type="text" id="student-package" readonly>
            </div>
        </div>
        
        <hr class="form__divider">
        
        <div class="form-grid">
            <div class="form-grid__field">
                <label>Giá gốc</label>
                <input type="number" id="student-original-price" readonly>
            </div>
             <div class="form-grid__field">
                <label>Mã giảm giá (%)</label>
                <input type="number" id="student-discount-percent" value="0" oninput="calculateFinalPrice()">
            </div>
             <div class="form-grid__field">
                <label>Khuyến mại (%)</label>
                <input type="number" id="student-promotion-percent" value="0" oninput="calculateFinalPrice()">
            </div>
            <div class="form-grid__field">
                <label>Tổng học phí</label>
                <input type="number" id="student-total-due" readonly>
            </div>
            <div class="form-grid__field">
                <label>Tiền sách</label>
                <input type="number" id="student-book-fee-due" value="0">
            </div>
        </div>
         <div class="form-grid form-grid--readonly-info">
            <div class="form-grid__field">
                <label>Số buổi đã học</label>
                <input type="number" id="student-total-attended-sessions" readonly>
            </div>
             <div class="form-grid__field">
                <label>Số buổi còn lại</label>
                <input type="number" id="student-remaining-sessions-display" readonly>
            </div>
         </div>
        <div class="modal__footer">
            <button type="button" class="modal__button modal__button--cancel" onclick="hideStudentForm()">Hủy</button>
            <button type="button" class="modal__button modal__button--reset" onclick="promptResetPackage()">Reset Gói</button>
        
            <button type="submit" class="modal__button modal__button--save">Lưu</button>
        </div>
    </form>
</div>
    </div>
    
    <div class="modal modal--class-form" id="class-form-modal" style="display: none;">
     <div class="modal__overlay" onclick="hideClassForm()"></div>
    <div class="modal__content" id="class-form-container">
        <div class="modal__header">
            <h3 class="modal__title" id="class-form-title">Tạo Lớp Học Mới</h3>
            <button class="modal__close-btn" onclick="hideClassForm()">&times;</button>
        </div>
        
        <form id="class-form" class="modal__form">
            <input type="hidden" id="class-index">
            <div class="form-grid">
                 <div class="form-grid__field">
                    <label for="class-name">Tên lớp</label>
                    <input type="text" id="class-name" required>
                </div>
                <div class="form-grid__field">
                    <label for="class-start-date">Ngày khai giảng</label>
                    <input type="date" id="class-start-date" required>
                </div>
                 <div class="form-grid__field">
                    <label for="class-teacher">Giáo viên</label>
                    <select id="class-teacher" required></select>
                </div>
                <div class="form-grid__field">
                    <label for="class-assistant-teacher">Trợ giảng</label>
                    <select id="class-assistant-teacher"></select>
                </div>
                <div class="form-grid__field">
                    <label for="class-room">Phòng học</label>
                     <select id="class-room">
                        <option value="Phòng 301">Phòng 301</option>
                        <option value="Phòng 302">Phòng 302</option>
                    </select>
                </div>
            </div>
            
             <div class="form-grid">
                <div class="form-grid__field">
                    <label for="class-type-select">Loại lớp học</label>
                    <select id="class-type-select" onchange="handleClassTypeChange()">
                       <option value="">-- Chọn loại lớp --</option>
    <option value="Lớp tiếng Anh phổ thông">Lớp tiếng Anh/Tiếng Trung phổ thông</option>
    <option value="Lớp chứng chỉ">Lớp chứng chỉ</option>
    <option value="Lớp các môn trên trường">Lớp các môn trên trường</option> </select>
                </div>
               <div id="class-certificate-options-container" class="form-grid__field form-field--hidden">
                    <label for="class-certificate-type-select">Loại chứng chỉ</label>
                    <select id="class-certificate-type-select" onchange="populateClassCertificateCourseDropdown()">
                        </select>
                    <label for="class-course-select" style="margin-top:10px;">Khóa học</label>
                    <select id="class-course-select">
                        </select>
                </div>
            </div>

            <fieldset id="fieldset-fixed-schedule" class="form__fieldset">
                <legend>Lịch học cố định</legend>
                 <div class="schedule-picker">
                    <div class="schedule-picker__day">
                        <input type="checkbox" id="schedule-mon" name="schedule-day" value="Monday">
                        <label for="schedule-mon">Thứ 2</label>
                        <select id="hour-mon" class="hour-select"></select>
                        <span>:</span>
                        <select id="minute-mon" class="minute-select"></select>
                    </div>
                    <div class="schedule-picker__day">
                         <input type="checkbox" id="schedule-tue" name="schedule-day" value="Tuesday">
                        <label for="schedule-tue">Thứ 3</label>
                        <select id="hour-tue" class="hour-select"></select>
                        <span>:</span>
                        <select id="minute-tue" class="minute-select"></select>
                    </div>
                    <div class="schedule-picker__day">
                        <input type="checkbox" id="schedule-wed" name="schedule-day" value="Wednesday">
                        <label for="schedule-wed">Thứ 4</label>
                        <select id="hour-wed" class="hour-select"></select>
                        <span>:</span>
                        <select id="minute-wed" class="minute-select"></select>
                    </div>
                    <div class="schedule-picker__day">
                         <input type="checkbox" id="schedule-thu" name="schedule-day" value="Thursday">
                        <label for="schedule-thu">Thứ 5</label>
                        <select id="hour-thu" class="hour-select"></select>
                        <span>:</span>
                        <select id="minute-thu" class="minute-select"></select>
                    </div>
                    <div class="schedule-picker__day">
                         <input type="checkbox" id="schedule-fri" name="schedule-day" value="Friday">
                        <label for="schedule-fri">Thứ 6</label>
                        <select id="hour-fri" class="hour-select"></select>
                        <span>:</span>
                        <select id="minute-fri" class="minute-select"></select>
                    </div>
                    <div class="schedule-picker__day">
                        <input type="checkbox" id="schedule-sat" name="schedule-day" value="Saturday">
                        <label for="schedule-sat">Thứ 7</label>
                        <select id="hour-sat" class="hour-select"></select>
                        <span>:</span>
                        <select id="minute-sat" class="minute-select"></select>
                    </div>
                     <div class="schedule-picker__day">
                         <input type="checkbox" id="schedule-sun" name="schedule-day" value="Sunday">
                        <label for="schedule-sun">Chủ Nhật</label>
                        <select id="hour-sun" class="hour-select"></select>
                        <span>:</span>
                        <select id="minute-sun" class="minute-select"></select>
                    </div>
                 </div>
            </fieldset>
            <button type="button" id="btn-change-schedule" onclick="showChangeScheduleModal()" style="display:none; margin-top:10px;">Thay đổi lịch học</button>

             <div id="class-add-wrapper" style="display: block;">
                <fieldset class="form__fieldset">
                     <legend>Thêm học viên vào lớp</legend>
                     <div class="student-adder">
                        <input type="text" id="class-add-student-search" class="student-adder__search" list="class-add-student-datalist" placeholder="Gõ tên để tìm học viên...">
                         <datalist id="class-add-student-datalist"></datalist>
                         <button type="button" class="student-adder__button" onclick="addStudentToClass()">Thêm</button>
                     </div>
                     <ul id="class-student-list" class="student-adder__list"></ul>
                </fieldset>
            </div>
            </form>
        <div class="modal__footer">
                <button type="button" class="modal__button modal__button--cancel" onclick="hideClassForm()">Hủy</button>
                <button type="button" class="modal__button modal__button--danger" onclick="convertAndExtendClass(document.getElementById('class-index').value)">Chuyển sang Lớp Phổ thông</button>
                <button type="submit" form="class-form" class="modal__button modal__button--save">Lưu Lớp</button>
        </div>
    </div>
</div>
     <div class="modal modal--attendance" id="class-attendance-modal-overlay" style="display: none;">
        <div class="modal__content modal__content--full-width">
            <div class="modal__header">
                <h3 class="modal__title" id="class-attendance-modal-title">Bảng điểm danh</h3>
              <div class="modal__controls">
    <button class="page-header__button" onclick="promptCreateMakeupSession()">Tạo Buổi Bù</button>
    <button class="page-header__button" onclick="promptAddExtraSession()">Thêm Buổi Học</button> <button onclick="scrollClassAttendanceBySessions(-1)">&lt;</button>
    <button onclick="scrollClassAttendanceBySessions(-1)">&lt;</button>
    <button onclick="scrollClassAttendanceBySessions(1)">&gt;</button>
</div>
                <button class="modal__close-btn" onclick="hideClassAttendanceModal()">&times;</button>
            </div>
            <div class="data-table-wrapper data-table-wrapper--scrollable" id="class-attendance-scroll-container">
    <table class="data-table data-table--attendance" id="class-attendance-table">
        <thead id="class-attendance-table-head" class="data-table__head"></thead>
        <tbody id="class-attendance-table-body" class="data-table__body"></tbody>
    </table>
</div>
        </div>
    </div>

    <div class="modal" id="approve-account-modal" style="display: none;">
        <div class="modal__overlay" onclick="hideApproveAccountModal()"></div>
        <div class="modal__content">
            <div class="modal__header">
                <h3 class="modal__title">Duyệt/Sửa Tài Khoản</h3>
                 <button class="modal__close-btn" onclick="hideApproveAccountModal()">&times;</button>
            </div>
            <p>Tài khoản: <strong id="approve-account-name"></strong></p>
            <div class="modal__form">
                <label for="approve-account-role-select">Chọn chức vụ:</label>
                <select id="approve-account-role-select">
                     <option value="">-- Chọn chức vụ --</option>
                    <option value="Admin">Admin</option>
                    <option value="Hội Đồng">Hội Đồng</option>
                    <option value="Giáo Viên">Giáo Viên</option>
                    <option value="Trợ Giảng">Trợ Giảng</option>
                </select>
            </div>
            <div class="modal__footer">
                 <button type="button" class="modal__button modal__button--cancel" onclick="hideApproveAccountModal()">Hủy</button>
                 <button type="button" class="modal__button modal__button--save" onclick="approveAccount()">Lưu thay đổi</button>
            </div>
        </div>
    </div>
    
    <div class="context-menu" id="schedule-context-menu">
        <ul class="context-menu__list">
            <li class="context-menu__item" id="menu-add-class">Tạo lớp học chính thức</li>
            <li class="context-menu__item" id="menu-add-temp-class">Tạo lớp học tạm thời</li>
        </ul>
    </div>
     <div class="context-menu" id="class-action-context-menu">
        <ul class="context-menu__list">
            <li class="context-menu__item" id="menu-edit-class">Sửa thông tin lớp</li>
        </ul>
    </div>
    
     <div class="modal" id="temp-class-form-modal" style="display: none;">
    <div class="modal__overlay" onclick="closeModal('temp-class-form-modal')"></div>
    <div class="modal__content">
        <div class="modal__header">
            <h3 class="modal__title" id="temp-class-form-title">Tạo Lớp Học Tạm Thời</h3>
            <button class="modal__close-btn" onclick="closeModal('temp-class-form-modal')">&times;</button>
        </div>
        
        <form id="temp-class-form" class="modal__form" onsubmit="saveTempClass(event)">
            <input type="hidden" id="temp-class-id">
            <input type="hidden" id="temp-class-room">
            
            <div class="form-grid">
                <div class="form-grid__field">
                    <label for="temp-class-name">Tên lớp</label>
                    <input type="text" id="temp-class-name" required>
                </div>
                <div class="form-grid__field">
                    <label for="temp-class-start-date">Ngày bắt đầu</label>
                    <input type="date" id="temp-class-start-date" required>
                </div>
                <div class="form-grid__field">
                    <label for="temp-class-teacher">Giáo viên</label>
                    <select id="temp-class-teacher" required></select>
                </div>
                <div class="form-grid__field">
                    <label for="temp-class-assistant">Trợ giảng</label>
                    <select id="temp-class-assistant"></select>
                </div>
            </div>

            <fieldset class="form__fieldset">
                <legend>Lịch học</legend>
                <div class="schedule-picker">
                    <div class="schedule-picker__day">
                        <input type="checkbox" id="temp-schedule-mon" name="temp-schedule-day" value="Monday"><label for="temp-schedule-mon">T2</label>
                        <select class="hour-select" id="temp-hour-mon"></select>:<select class="minute-select" id="temp-minute-mon"></select>
                    </div>
                    <div class="schedule-picker__day">
                        <input type="checkbox" id="temp-schedule-tue" name="temp-schedule-day" value="Tuesday"><label for="temp-schedule-tue">T3</label>
                        <select class="hour-select" id="temp-hour-tue"></select>:<select class="minute-select" id="temp-minute-tue"></select>
                    </div>
                    <div class="schedule-picker__day">
                        <input type="checkbox" id="temp-schedule-wed" name="temp-schedule-day" value="Wednesday"><label for="temp-schedule-wed">T4</label>
                        <select class="hour-select" id="temp-hour-wed"></select>:<select class="minute-select" id="temp-minute-wed"></select>
                    </div>
                    <div class="schedule-picker__day">
                        <input type="checkbox" id="temp-schedule-thu" name="temp-schedule-day" value="Thursday"><label for="temp-schedule-thu">T5</label>
                        <select class="hour-select" id="temp-hour-thu"></select>:<select class="minute-select" id="temp-minute-thu"></select>
                    </div>
                    <div class="schedule-picker__day">
                        <input type="checkbox" id="temp-schedule-fri" name="temp-schedule-day" value="Friday"><label for="temp-schedule-fri">T6</label>
                        <select class="hour-select" id="temp-hour-fri"></select>:<select class="minute-select" id="temp-minute-fri"></select>
                    </div>
                    <div class="schedule-picker__day">
                        <input type="checkbox" id="temp-schedule-sat" name="temp-schedule-day" value="Saturday"><label for="temp-schedule-sat">T7</label>
                        <select class="hour-select" id="temp-hour-sat"></select>:<select class="minute-select" id="temp-minute-sat"></select>
                    </div>
                    <div class="schedule-picker__day">
                        <input type="checkbox" id="temp-schedule-sun" name="temp-schedule-day" value="Sunday"><label for="temp-schedule-sun">CN</label>
                        <select class="hour-select" id="temp-hour-sun"></select>:<select class="minute-select" id="temp-minute-sun"></select>
                    </div>
                </div>
            </fieldset>
            
            <fieldset class="form__fieldset">
                <legend>Học viên</legend>
                <div class="student-adder">
                    <input type="text" id="temp-class-student-search" class="student-adder__search" placeholder="Gõ tên để tìm...">
                    <div class="student-adder__results" id="temp-class-student-results"></div>
                </div>
                <div class="student-adder__selected-list" id="temp-class-selected-students"></div>
            </fieldset>

            <div class="modal__footer">
                <button type="button" class="modal__button modal__button--cancel" onclick="closeModal('temp-class-form-modal')">Hủy</button>
                <button type="submit" class="modal__button modal__button--save">Lưu Lớp</button>
            </div>
        </form>
        </div>
</div>
    
    <div class="modal" id="change-schedule-modal" style="display: none;">
        <div class="modal__overlay" onclick="hideChangeScheduleModal()"></div>
        <div class="modal__content">
            <div class="modal__header">
                <h3 class="modal__title">Thay Đổi Lịch Học</h3>
                <button class="modal__close-btn" onclick="hideChangeScheduleModal()">&times;</button>
            </div>
            <form id="change-schedule-form" class="modal__form" onsubmit="event.preventDefault(); confirmScheduleChange();">
                <input type="hidden" id="change-schedule-class-id">
                <div class="form-grid__field">
                    <label for="change-schedule-date">Áp dụng từ ngày</label>
                    <input type="date" id="change-schedule-date" required>
                </div>
                 <fieldset class="form__fieldset">
                    <legend>Lịch học cố định MỚI</legend>
                    <div id="new-fixed-schedule-container" class="schedule-picker">
                       <div class="schedule-picker__day">
                            <input type="checkbox" id="new-schedule-mon" name="new-schedule-day"><label for="new-schedule-mon">T2</label>
                            <select class="hour-select" id="new-hour-mon"></select>:<select class="minute-select" id="new-minute-mon"></select>
                        </div>
                        <div class="schedule-picker__day">
                            <input type="checkbox" id="new-schedule-tue" name="new-schedule-day"><label for="new-schedule-tue">T3</label>
                            <select class="hour-select" id="new-hour-tue"></select>:<select class="minute-select" id="new-minute-tue"></select>
                        </div>
                         <div class="schedule-picker__day">
                            <input type="checkbox" id="new-schedule-wed" name="new-schedule-day" value="Wednesday"><label for="new-schedule-wed">T4</label>
                            <select class="hour-select" id="new-hour-wed"></select>:<select class="minute-select" id="new-minute-wed"></select>
                        </div>
                         <div class="schedule-picker__day">
                            <input type="checkbox" id="new-schedule-thu" name="new-schedule-day" value="Thursday"><label for="new-schedule-thu">T5</label>
                            <select class="hour-select" id="new-hour-thu"></select>:<select class="minute-select" id="new-minute-thu"></select>
                        </div>
                         <div class="schedule-picker__day">
                            <input type="checkbox" id="new-schedule-fri" name="new-schedule-day" value="Friday"><label for="new-schedule-fri">T6</label>
                            <select class="hour-select" id="new-hour-fri"></select>:<select class="minute-select" id="new-minute-fri"></select>
                        </div>
                         <div class="schedule-picker__day">
                            <input type="checkbox" id="new-schedule-sat" name="new-schedule-day" value="Saturday"><label for="new-schedule-sat">T7</label>
                            <select class="hour-select" id="new-hour-sat"></select>:<select class="minute-select" id="new-minute-sat"></select>
                        </div>
                         <div class="schedule-picker__day">
                            <input type="checkbox" id="new-schedule-sun" name="new-schedule-day" value="Sunday"><label for="new-schedule-sun">CN</label>
                            <select class="hour-select" id="new-hour-sun"></select>:<select class="minute-select" id="new-minute-sun"></select>
                        </div>
                    </div>
                 </fieldset>
                <div class="modal__footer">
                    <button type="button" class="modal__button modal__button--cancel" onclick="hideChangeScheduleModal()">Hủy</button>
                    <button type="submit" class="modal__button modal__button--save">Xác Nhận Thay Đổi</button>
                </div>
            </form>
        </div>
    </div>
    
     <div class="modal modal--attendance" id="personnel-attendance-modal" style="display: none;">
        <div class="modal__content modal__content--full-width">
            <div class="modal__header">
                <h3 class="modal__title">Chấm Công Nhân Sự: <span id="current-personnel-class-name"></span></h3>
                <div class="modal__controls">
                    <button onclick="scrollPersonnelAttendanceBySessions(-1)">&lt;</button>
                    <button onclick="scrollPersonnelAttendanceBySessions(1)">&gt;</button>
                </div>
                <button class="modal__close-btn" onclick="hidePersonnelAttendanceModal()">&times;</button>
            </div>
            <div class="data-table-wrapper data-table-wrapper--scrollable" id="personnel-attendance-scroll-container">
                <table class="data-table data-table--attendance">
                    <thead id="personnel-attendance-table-head" class="data-table__head"></thead>
                    <tbody id="personnel-attendance-table-body" class="data-table__body"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="modal" id="staff-classes-salary-modal" style="display: none;">
        <div class="modal__overlay" onclick="hideStaffClassesSalaryModal()"></div>
        <div class="modal__content modal__content--large">
            <div class="modal__header">
                <h3 class="modal__title">Quản lý lương theo lớp cho: <span id="staff-classes-salary-name"></span></h3>
                <button class="modal__close-btn" onclick="hideStaffClassesSalaryModal()">&times;</button>
            </div>
            <div class="data-table-wrapper">
                 <table class="data-table">
                     <thead class="data-table__head">
                        <tr class="data-table__row">
                            <th class="data-table__header">Tên lớp</th>
                            <th class="data-table__header">Vai trò</th>
                            <th class="data-table__header">Lương/Buổi (VNĐ)</th>
                            <th class="data-table__header">Hành động</th>
                        </tr>
                     </thead>
                     <tbody id="staff-individual-class-salary-list" class="data-table__body">
                         </tbody>
                 </table>
            </div>
        </div>
    </div>

    <div class="modal" id="salary-detail-modal" style="display: none;">
        <div class="modal__overlay" onclick="hideSalaryDetailModal()"></div>
        <div class="modal__content modal__content--large">
            <div class="modal__header">
                <h3 class="modal__title">Chi Tiết Lương: <span id="salary-detail-name"></span></h3>
                <button class="modal__close-btn" onclick="hideSalaryDetailModal()">&times;</button>
            </div>
            <div class="salary-detail">
                <div class="salary-detail__controls">
                    <label for="salary-month-select">Xem lương tháng:</label>
                    <input type="month" id="salary-month-select">
                </div>
                <div class="salary-detail__summary">
                    <h4>Tổng kết tháng <span id="summary-month-year"></span></h4>
                    <p>Tổng lương: <strong id="total-monthly-salary">0</strong> VNĐ</p>
                    <p>Tổng ca dạy (GV): <span id="total-teacher-shifts">0</span></p>
                    <p>Tổng ca dạy (TG): <span id="total-assistant-shifts">0</span></p>
                    <small id="salary-period-note"></small>
                </div>
                <div class="salary-detail__chart-container">
                    <canvas id="personnel-daily-chart"></canvas>
                </div>
                <div class="salary-detail__details-list">
                    <h4>Chi tiết chấm công</h4>
                    <ul id="daily-shifts-list">
                        </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="modal" id="class-book-fee-modal" style="display: none;">
        <div class="modal__overlay" onclick="this.parentElement.style.display='none'"></div>
        <div class="modal__content modal__content--extra-large">
            <div class="modal__header">
                <h3 class="modal__title">Tổng Quan Tiền Sách: <span id="class-book-fee-name"></span></h3>
                <div> <button class="modal__button modal__button--save" onclick="showUpdateClassBookModal()">Cập nhật Sách</button>
                       <button class="modal__button modal__button--danger" onclick="promptResetClassBookFee()">Reset Tiền sách Lớp</button>
                 </div>
                <button class="modal__close-btn" onclick="this.closest('.modal').style.display='none'">&times;</button>
            </div>
            <div class="data-table-wrapper">
                <table class="data-table">
                    <thead class="data-table__head">
                        <tr class="data-table__row">
                            <th class="data-table__header">Học viên</th>
                            <th class="data-table__header">Tên sách</th>
                            <th class="data-table__header">Tổng tiền</th>
                            <th class="data-table__header">Trạng thái Đóng</th>
                            <th class="data-table__header">Lịch sử</th>
                        </tr>
                    </thead>
                    <tbody id="class-book-fee-student-list" class="data-table__body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal" id="update-class-book-modal" style="display: none;">
        <div class="modal__overlay" onclick="this.parentElement.style.display='none'"></div>
        <div class="modal__content">
            <div class="modal__header">
                <h3 class="modal__title">Cập nhật Sách cho lớp</h3>
                <button class="modal__close-btn" onclick="this.closest('.modal').style.display='none'">&times;</button>
            </div>
            <form id="update-class-book-form" class="modal__form" onsubmit="event.preventDefault(); saveClassBookInfo();">
                <input type="hidden" id="update-book-class-id">
                <div class="form-grid__field form-grid__field--full">
                    <label for="class-book-name">Tên sách</label>
                    <input type="text" id="class-book-name" required>
                </div>
                <div class="form-grid__field form-grid__field--full">
                    <label for="class-book-type">Loại sách (ví dụ: SGK + SBT)</label>
                    <input type="text" id="class-book-type">
                </div>
                <div class="form-grid__field form-grid__field--full">
                    <label for="class-book-fee">Tiền sách (VNĐ)</label>
                    <input type="number" id="class-book-fee" required>
                </div>
                <div class="modal__footer">
                    <button type="button" class="modal__button modal__button--cancel" onclick="this.closest('.modal').style.display='none'">Hủy</button>
                    <button type="submit" class="modal__button modal__button--save">Lưu thông tin</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="class-tuition-modal" style="display: none;">
        <div class="modal__overlay" onclick="this.parentElement.style.display='none'"></div>
        <div class="modal__content modal__content--extra-large">
            <div class="modal__header">
                <h3 class="modal__title">Tổng Quan Học Phí Lớp: <span id="class-tuition-name"></span></h3>
                <button class="modal__close-btn" onclick="this.closest('.modal').style.display='none'">&times;</button>
            </div>
            <div class="data-table-wrapper">
                <table class="data-table data-table--tuition">
                    <thead class="data-table__head">
                        <tr class="data-table__row">
                            <th class="data-table__header">Học viên</th>
                            <th class="data-table__header">Loại phí</th>
                            <th class="data-table__header">Tổng phải đóng</th>
                            <th class="data-table__header">Đã đóng</th>
                            <th class="data-table__header">Còn lại</th>
                            <th class="data-table__header">Trạng thái</th>
                            <th class="data-table__header">Lịch sử</th>
                        </tr>
                    </thead>
                    <tbody id="class-tuition-student-list" class="data-table__body"></tbody>
                </table>
            </div>
        </div>
    </div>
    
        <div class="modal" id="tuition-modal" style="display: none;">
        <div class="modal__overlay" onclick="hideTuitionModal()"></div>
        <div class="modal__content modal__content--large">
            <div class="modal__header">
                <h3 class="modal__title">Lịch Sử Thanh Toán Học Phí: <span id="tuition-student-name"></span></h3>
                <button class="modal__close-btn" onclick="hideTuitionModal()">&times;</button>
            </div>
            
            <input type="hidden" id="tuition-student-id">
            <input type="hidden" id="tuition-modal-class-id">

            <div class="tuition-summary">
                <div class="tuition-summary__item">
                    <span>Tổng học phí:</span>
                    <strong id="tuition-total-due">0 VNĐ</strong>
                </div>
                 <div class="tuition-summary__item">
                    <span>Đã đóng:</span>
                    <strong id="tuition-total-paid" class="tuition-summary__paid">0 VNĐ</strong>
                </div>
                 <div class="tuition-summary__item">
                    <span>Còn lại:</span>
                    <strong id="tuition-remaining-balance" class="tuition-summary__remaining">0 VNĐ</strong>
                </div>
            </div>
            
            <div class="tabs__content active" style="padding: 24px;">
                <h4>Ghi nhận thanh toán học phí mới</h4>
                <form id="tuition-payment-form" class="modal__form modal__form--inline" onsubmit="event.preventDefault(); savePayment();">
                    <input type="number" id="tuition-amount-input" placeholder="Số tiền" required>
                    <select id="tuition-method-select">
                        <option value="Tiền mặt">Tiền mặt</option>
                        <option value="Chuyển khoản">Chuyển khoản</option>
                    </select>
                    <input type="text" id="tuition-holder-input" placeholder="Tên người cầm tiền" required>
                    <input type="text" id="tuition-note-input" placeholder="Ghi chú (tùy chọn)">
                    <button type="submit" class="modal__button modal__button--save">Lưu</button>
                </form>

                <h4>Lịch sử đóng học phí</h4>
                <div class="data-table-wrapper data-table-wrapper--modal">
                    <table class="data-table">
                        <thead class="data-table__head">
                            <tr class="data-table__row">
                                <th class="data-table__header">Ngày</th>
                                <th class="data-table__header">Số tiền</th>
                                <th class="data-table__header">Hình thức</th>
                                <th class="data-table__header">Ghi chú</th>
                                <th class="data-table__header">Người nhận</th>
                                <th class="data-table__header">Xóa</th>
                            </tr>
                        </thead>
                        <tbody id="tuition-history-list" class="data-table__body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="progress-modal" style="display: none;">
        <div class="modal__overlay" onclick="this.parentElement.style.display='none'"></div>
        <div class="modal__content modal__content--extra-large">
            <div class="modal__header">
                <h3 class="modal__title">Phân Tích Tiến Bộ Học Tập: <span id="progress-student-name"></span></h3>
                <button class="modal__close-btn" onclick="this.closest('.modal').style.display='none'">&times;</button>
            </div>
            <div class="progress-container">
                <div class="progress-container__summary" id="progress-summary">
                    </div>
                <div class="progress-container__charts">
                    <div class="chart-wrapper">
                        <canvas id="progress-over-time-chart"></canvas>
                    </div>
                    <div class="chart-wrapper">
                         <canvas id="progress-breakdown-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        </div>
        <div class="modal" id="class-tuition-modal" style="display: none;">
        <div class="modal__overlay" onclick="this.parentElement.style.display='none'"></div>
        <div class="modal__content modal__content--extra-large">
            <div class="modal__header">
                <h3 class="modal__title">Tổng Quan Học Phí Lớp: <span id="class-tuition-name"></span></h3>
                <button class="modal__close-btn" onclick="this.closest('.modal').style.display='none'">&times;</button>
            </div>
            <div class="data-table-wrapper">
                <table class="data-table data-table--tuition">
                    <thead class="data-table__head">
                        <tr class="data-table__row">
                            <th class="data-table__header">Học viên</th>
                            <th class="data-table__header">Loại phí</th>
                            <th class="data-table__header">Tổng phải đóng</th>
                            <th class="data-table__header">Đã đóng</th>
                            <th class="data-table__header">Còn lại</th>
                            <th class="data-table__header">Trạng thái</th>
                            <th class="data-table__header">Chi tiết</th>
                        </tr>
                    </thead>
                    <tbody id="class-tuition-student-list" class="data-table__body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal" id="tuition-modal" style="display: none;">
        <div class="modal__overlay" onclick="hideTuitionModal()"></div>
        <div class="modal__content modal__content--large">
            <div class="modal__header">
                <h3 class="modal__title">Lịch Sử Thanh Toán: <span id="tuition-student-name"></span></h3>
                <button class="modal__close-btn" onclick="hideTuitionModal()">&times;</button>
            </div>
            
            <input type="hidden" id="tuition-student-id">
            <input type="hidden" id="tuition-modal-class-id">

            <div class="tuition-summary">
                <div class="tuition-summary__item">
                    <span>Tổng học phí:</span>
                    <strong id="tuition-total-due">0 VNĐ</strong>
                </div>
                 <div class="tuition-summary__item">
                    <span>Đã đóng:</span>
                    <strong id="tuition-total-paid" class="tuition-summary__paid">0 VNĐ</strong>
                </div>
                 <div class="tuition-summary__item">
                    <span>Còn lại:</span>
                    <strong id="tuition-remaining-balance" class="tuition-summary__remaining">0 VNĐ</strong>
                </div>
            </div>
            
           <div class="tabs">
                 <button class="tabs__button active" onclick="openPageTab(event, 'fee-management', 'tuition-management')">Quản lý Học phí</button>
                 <button class="tabs__button" onclick="openPageTab(event, 'book-management', 'tuition-management')">Quản lý Tiền sách</button>
            </div>

            <div id="payment-tab" class="tabs__content active">
                <h4>Ghi nhận thanh toán học phí mới</h4>
                <form id="tuition-payment-form" class="modal__form modal__form--inline" onsubmit="event.preventDefault(); savePayment();">
                    <input type="number" id="tuition-amount-input" placeholder="Số tiền" required>
                    <select id="tuition-method-select">
                        <option value="Tiền mặt">Tiền mặt</option>
                        <option value="Chuyển khoản">Chuyển khoản</option>
                    </select>
                    <input type="text" id="tuition-holder-input" placeholder="Tên người cầm tiền" required>
                    <input type="text" id="tuition-note-input" placeholder="Ghi chú (tùy chọn)">
                    <button type="submit" class="modal__button modal__button--save">Lưu</button>
                </form>

                <h4>Lịch sử đóng học phí</h4>
                <div class="data-table-wrapper data-table-wrapper--modal">
                    <table class="data-table">
                        <thead class="data-table__head">
                            <tr class="data-table__row">
                                <th class="data-table__header">Ngày</th>
                                <th class="data-table__header">Số tiền</th>
                                <th class="data-table__header">Hình thức</th>
                                <th class="data-table__header">Ghi chú</th>
                                <th class="data-table__header">Người nhận</th>
                                <th class="data-table__header">Xóa</th>
                            </tr>
                        </thead>
                        <tbody id="tuition-history-list" class="data-table__body"></tbody>
                    </table>
                </div>
            </div>

            <div id="book-fee-tab" class="tabs__content">
                 <h4>Ghi nhận thanh toán tiền sách mới</h4>
                 <button onclick="promptSetBookFeeDue()" class="modal__button modal__button--secondary">Cập nhật Tổng nợ Tiền sách</button>
                 
                 <div id="book-selection-container" class="book-selector">
                     </div>
                 
                <form id="book-fee-payment-form" class="modal__form modal__form--inline" onsubmit="event.preventDefault(); saveBookFeePayment();">
                    <input type="text" id="book-fee-title-final" placeholder="Tên sách (tự động)" readonly>
                    <input type="number" id="book-fee-amount-input" placeholder="Số tiền" required>
                    <select id="book-fee-method-select">
                        <option value="Tiền mặt">Tiền mặt</option>
                        <option value="Chuyển khoản">Chuyển khoản</option>
                    </select>
                     <input type="text" id="book-fee-holder-input" placeholder="Tên người cầm tiền" required>
                    <input type="text" id="book-fee-note-input" placeholder="Ghi chú (tùy chọn)">
                    <button type="submit" class="modal__button modal__button--save">Lưu</button>
                </form>

                <h4>Lịch sử đóng tiền sách</h4>
                 <div class="data-table-wrapper data-table-wrapper--modal">
                    <table class="data-table">
                        <thead class="data-table__head">
                            <tr class="data-table__row">
                                <th class="data-table__header">Ngày</th>
                                <th class="data-table__header">Số tiền</th>
                                <th class="data-table__header">Tên sách</th>
                                <th class="data-table__header">Ghi chú</th>
                                <th class="data-table__header">Người nhận</th>
                                <th class="data-table__header">Xóa</th>
                            </tr>
                        </thead>
                        <tbody id="book-fee-history-list" class="data-table__body"></tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
    <div class="modal" id="transfer-student-modal" style="display: none;">
    <div class="modal__overlay" onclick="this.parentElement.style.display='none'"></div>
    <div class="modal__content">
        <div class="modal__header">
            <h3 class="modal__title">Chuyển lớp cho học viên</h3>
            <button class="modal__close-btn" onclick="this.closest('.modal').style.display='none'">&times;</button>
        </div>
        <div class="modal__form">
            <input type="hidden" id="transfer-student-id">
            <p>Học viên: <strong id="transfer-student-name"></strong></p>
            <p>Từ lớp: <strong id="transfer-from-class-name"></strong></p>
            <input type="hidden" id="transfer-from-class-id">

            <div class="form-grid__field" style="margin-top: 20px;">
                <label for="transfer-to-class-select">Chuyển đến lớp:</label>
                <select id="transfer-to-class-select" required>
                    <option value="">-- Chọn lớp mới --</option>
                </select>
            </div>
        </div>
        <div class="modal__footer">
            <button type="button" class="modal__button modal__button--cancel" onclick="this.closest('.modal').style.display='none'">Hủy</button>
            <button type="button" class="modal__button modal__button--save" onclick="executeTransfer()">Xác nhận chuyển lớp</button>
        </div>
    </div>
</div>
    
          <div id="class-info-tooltip"></div>
<script src="https://unpkg.com/lucide-static@latest/dist/lucide.min.js"></script>
    <script src="script.js"></script>
    <script>
        // Simple tab functionality for tuition modal
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabs__content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                tabcontent[i].classList.remove("active");
            }
            tablinks = document.getElementsByClassName("tabs__button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.className += " active";
        }
    </script>
  
</body>
</html>
